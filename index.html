<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>HMD - BAC 2026 Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/appwrite@14.0.1"></script>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #ec4899;
            --accent: #06b6d4;
            --success: #22c55e;
            --danger: #ef4444;
            --dark: #0f172a;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-900: #0f172a;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            color: var(--gray-900);
            transition: all 0.3s ease;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            padding: 0;
            margin: 0;
        }
        
        body.dark-mode {
            background: linear-gradient(135deg, #000000 0%, #0f172a 100%);
            color: #f8fafc;
        }
        
        body.dark-mode .panel,
        body.dark-mode .login-container,
        body.dark-mode .admin-panel {
            background: rgba(30, 41, 59, 0.98);
            color: #f8fafc;
        }
        
        body.dark-mode .tab,
        body.dark-mode select,
        body.dark-mode input[type="number"],
        body.dark-mode input[type="text"],
        body.dark-mode input[type="email"],
        body.dark-mode input[type="password"] {
            background: #334155;
            border-color: #475569;
            color: #f8fafc;
        }
        
        body.dark-mode tbody tr:hover {
            background: #334155;
        }

        .login-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
            transition: opacity 0.3s ease;
            padding: 16px;
        }

        .login-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .login-container {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 24px;
            padding: 32px 24px;
            max-width: 420px;
            width: 100%;
            box-shadow: 0 40px 100px -20px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .login-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .login-logo {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 16px;
            margin: 0 auto 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3);
        }

        .login-title {
            font-size: 1.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #6366f1 0%, #ec4899 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 6px;
        }

        .login-subtitle {
            color: var(--gray-600);
            font-size: 0.85rem;
        }

        .login-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            background: var(--gray-100);
            padding: 4px;
            border-radius: 10px;
        }

        body.dark-mode .login-tabs {
            background: #334155;
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--gray-600);
            font-size: 0.9rem;
        }

        .tab-btn.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        body.dark-mode .tab-btn.active {
            background: #475569;
            color: #818cf8;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--gray-700);
            font-size: 0.85rem;
        }

        body.dark-mode .form-label {
            color: #cbd5e1;
        }

        .form-input {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid var(--gray-200);
            border-radius: 10px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background: var(--gray-50);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .login-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        .login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .error-message {
            padding: 10px;
            border-radius: 8px;
            font-size: 0.85rem;
            display: none;
            margin-bottom: 12px;
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .error-message.show {
            display: block;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .user-info {
            position: relative;
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 14px;
            border-radius: 40px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: none;
            align-items: center;
            gap: 8px;
            z-index: 1000;
            font-size: 0.85rem;
            margin: 12px;
            overflow: hidden;
        }

        .user-info-wrapper {
            width: 100%;
            display: none;
        }

        .user-info-wrapper.show {
            display: block;
        }

        body.dark-mode .user-info {
            background: rgba(30, 41, 59, 0.95);
        }

        .user-info.show {
            display: flex;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .logout-btn,
        .admin-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .admin-btn {
            background: var(--accent);
        }

        .logout-btn:hover {
            background: #dc2626;
        }

        .admin-btn:hover {
            background: #0891b2;
        }

        .header {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.9), rgba(236, 72, 153, 0.9));
            padding: 20px 16px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .logo {
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 16px;
            margin: 0 auto 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        .title {
            font-size: 1.75rem;
            font-weight: 900;
            color: white;
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            margin-bottom: 6px;
        }

        .subtitle {
            color: rgba(255, 255, 255, 0.95);
            font-size: 0.95rem;
            font-weight: 500;
        }

        .theme-toggle {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            width: 42px;
            height: 42px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1rem;
            color: white;
        }

        .theme-toggle:hover {
            transform: scale(1.1) rotate(15deg);
            background: rgba(255, 255, 255, 0.3);
        }

        .tabs {
            display: flex;
            justify-content: center;
            gap: 8px;
            padding: 16px 12px;
            background: var(--gray-50);
            flex-wrap: nowrap;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        body.dark-mode .tabs {
            background: #0f172a;
        }

        .tab {
            padding: 10px 20px;
            background: white;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            color: var(--gray-700);
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
            font-size: 0.85rem;
            flex-shrink: 0;
        }

        .tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .tab.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-color: transparent;
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        body.dark-mode .tab {
            background: #1e293b;
            border-color: #334155;
            color: #cbd5e1;
        }

        body.dark-mode .tab.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px 12px;
        }

        .panel {
            display: none;
            background: white;
            padding: 24px 16px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
        }

        .panel.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .panel-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .panel-icon {
            font-size: 3rem;
            margin-bottom: 12px;
        }

        .panel-title {
            font-size: 1.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .panel-subtitle {
            color: var(--gray-600);
            font-size: 0.9rem;
        }

        body.dark-mode .panel-subtitle {
            color: #94a3b8;
        }

        .form-row {
            display: grid;
            gap: 12px;
            margin-bottom: 16px;
        }

        .form-row.cols-2 { grid-template-columns: 1fr; }
        .form-row.cols-3 { grid-template-columns: 1fr; }
        .form-row.cols-4 { grid-template-columns: 1fr; }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--gray-700);
            font-size: 0.85rem;
        }

        body.dark-mode label {
            color: #cbd5e1;
        }

        select,
        input[type="number"],
        input[type="text"],
        input[type="email"],
        input[type="password"] {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid var(--gray-200);
            border-radius: 10px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            background: var(--gray-50);
        }

        select:focus,
        input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .table-wrapper {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin: 16px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            font-size: 0.75rem;
        }

        thead {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        th, td {
            padding: 8px 4px;
            text-align: center;
        }

        th {
            font-weight: 700;
            font-size: 0.7rem;
        }

        tbody tr {
            background: white;
            transition: background 0.3s ease;
        }

        tbody tr:nth-child(even) {
            background: var(--gray-50);
        }

        tbody tr:hover {
            background: rgba(99, 102, 241, 0.05);
        }

        body.dark-mode tbody tr {
            background: #1e293b;
        }

        body.dark-mode tbody tr:nth-child(even) {
            background: #0f172a;
        }

        tbody input {
            padding: 5px 6px;
            font-size: 0.75rem;
            min-width: 45px;
        }

        .btn-group {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            flex: 1;
            min-width: 140px;
            justify-content: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--accent), #0891b2);
            color: white;
            box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(6, 182, 212, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #16a34a);
            color: white;
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
        }

        .result-box {
            display: none;
            text-align: center;
            padding: 28px 20px;
            border-radius: 16px;
            margin: 20px 0;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .result-box.show {
            display: block;
            animation: bounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes bounceIn {
            0% { opacity: 0; transform: scale(0.3); }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }

        .result-box.excellent {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
        }

        .result-box.good {
            background: linear-gradient(135deg, #06b6d4, #0891b2);
            color: white;
        }

        .result-box.average {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .result-box.weak {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .result-icon {
            font-size: 3rem;
            margin-bottom: 12px;
        }

        .result-text {
            font-size: 1.5rem;
            font-weight: 900;
            margin-bottom: 8px;
        }

        .result-message {
            font-size: 1rem;
            font-weight: 600;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(236, 72, 153, 0.1));
            padding: 20px;
            border-radius: 14px;
            text-align: center;
            border: 2px solid rgba(99, 102, 241, 0.2);
        }

        body.dark-mode .stat-card {
            background: rgba(30, 41, 59, 0.95);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--gray-600);
            margin-bottom: 6px;
            font-weight: 600;
        }

        body.dark-mode .stat-label {
            color: #cbd5e1;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .success-message {
            position: fixed;
            top: 16px;
            left: 50%;
            transform: translateX(-50%) translateY(-200%);
            background: linear-gradient(135deg, var(--success), #16a34a);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(34, 197, 94, 0.4);
            font-weight: 700;
            z-index: 10000;
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            font-size: 0.9rem;
            max-width: calc(100vw - 32px);
            text-align: center;
        }

        .success-message.show {
            transform: translateX(-50%) translateY(0);
        }

        .admin-panel {
            display: none !important;
            background: white;
            padding: 24px 16px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .admin-panel.show {
            display: block !important;
        }

        .admin-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .admin-title {
            font-size: 1.75rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--danger));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 12px;
        }

        .students-table {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 16px 0;
        }

        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        /* iPhone 17 Pro (430 x 932) */
        @media (max-width: 430px) and (min-height: 900px) {
            .title { font-size: 1.6rem; }
            .login-container { padding: 28px 20px; }
            .form-row.cols-2,
            .form-row.cols-3,
            .form-row.cols-4 { grid-template-columns: 1fr; }
        }

        /* iPhone 14 Pro Max, iPhone 15 Pro Max (430 x 932) */
        @media (max-width: 430px) {
            .title { font-size: 1.6rem; }
            .subtitle { font-size: 0.9rem; }
            table { font-size: 0.75rem; }
            th, td { padding: 8px 4px; }
        }

        /* iPhone 14 Pro, iPhone 15 Pro (393 x 852) */
        @media (max-width: 393px) {
            .title { font-size: 1.5rem; }
            .panel { padding: 20px 12px; }
            .btn { min-width: 120px; padding: 10px 16px; }
        }

        /* iPhone SE, iPhone 12 mini, iPhone 13 mini (375 x 667/812) */
        @media (max-width: 375px) {
            .title { font-size: 1.4rem; }
            .subtitle { font-size: 0.85rem; }
            .logo { width: 50px; height: 50px; font-size: 1.75rem; }
            .login-container { padding: 24px 16px; }
            .login-logo { width: 50px; height: 50px; font-size: 1.75rem; }
            .login-title { font-size: 1.3rem; }
            .panel-icon { font-size: 2.5rem; }
            .panel-title { font-size: 1.3rem; }
            table { font-size: 0.65rem; }
            th, td { padding: 6px 2px; }
            tbody input { padding: 4px 4px; font-size: 0.7rem; min-width: 40px; }
            .btn { min-width: 110px; padding: 9px 14px; font-size: 0.8rem; }
            .user-info { font-size: 0.75rem; padding: 6px 10px; }
            .user-avatar { width: 28px; height: 28px; font-size: 0.8rem; }
            .logout-btn, .admin-btn { padding: 5px 10px; font-size: 0.7rem; }
        }

        /* Galaxy Fold (280 x 653) */
        @media (max-width: 280px) {
            .title { font-size: 1.2rem; }
            .subtitle { font-size: 0.75rem; }
            .logo { width: 40px; height: 40px; font-size: 1.5rem; }
            .tabs { gap: 4px; padding: 12px 8px; }
            .tab { padding: 8px 12px; font-size: 0.75rem; gap: 4px; }
            .btn-group { gap: 6px; }
            .btn { min-width: 100px; padding: 8px 12px; font-size: 0.75rem; }
            table { font-size: 0.65rem; }
        }

        /* Tablets (768px and above) */
        @media (min-width: 768px) {
            .title { font-size: 2rem; }
            .panel { padding: 32px 24px; }
            .form-row.cols-2 { grid-template-columns: repeat(2, 1fr); }
            .form-row.cols-3 { grid-template-columns: repeat(3, 1fr); }
            .form-row.cols-4 { grid-template-columns: repeat(2, 1fr); }
            table { font-size: 0.9rem; }
            th, td { padding: 12px 8px; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .tabs { flex-wrap: wrap; }
            .btn-group { flex-wrap: wrap; }
            .btn { flex: 0 1 auto; }
        }

        /* Desktop (1024px and above) */
        @media (min-width: 1024px) {
            .title { font-size: 2.5rem; }
            .subtitle { font-size: 1.1rem; }
            .panel { padding: 40px; }
            .form-row.cols-2 { grid-template-columns: repeat(2, 1fr); }
            .form-row.cols-3 { grid-template-columns: repeat(3, 1fr); }
            .form-row.cols-4 { grid-template-columns: repeat(4, 1fr); }
            table { font-size: 1rem; }
            th, td { padding: 14px 12px; }
            .stats-grid { grid-template-columns: repeat(3, 1fr); }
            .login-container { padding: 48px 40px; }
        }

        /* Landscape orientation */
        @media (max-height: 500px) and (orientation: landscape) {
            .login-container { max-height: 85vh; }
            .header { padding: 12px 16px; }
            .logo { width: 40px; height: 40px; font-size: 1.5rem; margin-bottom: 8px; }
            .title { font-size: 1.3rem; }
            .subtitle { font-size: 0.8rem; }
            .panel-header { margin-bottom: 16px; }
            .panel-icon { font-size: 2rem; }
        }
    </style>
</head>
<body>
    <div class="login-overlay" id="loginOverlay">
        <div class="login-container">
            <div class="login-header">
                <div class="login-logo">ğŸ“</div>
                <h2 class="login-title">HMD - BAC 2026</h2>
                <p class="login-subtitle">Ù†Ø¸Ø§Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¹Ø¯Ù„Ø§Øª Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</p>
            </div>

            <div class="login-tabs">
                <button class="tab-btn active" onclick="switchAuthTab('login')">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
                <button class="tab-btn" onclick="switchAuthTab('register')">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
            </div>

            <div id="loginForm" class="tab-content active">
                <form class="login-form" onsubmit="handleLogin(event)">
                    <div class="error-message" id="loginError"></div>
                    
                    <div class="form-group">
                        <label class="form-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                        <input type="email" class="form-input" id="loginEmail" required placeholder="example@email.com">
                    </div>

                    <div class="form-group">
                        <label class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                        <input type="password" class="form-input" id="loginPassword" required placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                    </div>

                    <button type="submit" class="login-btn" id="loginBtn">
                        <i class="fas fa-sign-in-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                    </button>
                </form>
            </div>

            <div id="registerForm" class="tab-content">
                <form class="login-form" onsubmit="handleRegister(event)">
                    <div class="error-message" id="registerError"></div>
                    
                    <div class="form-group">
                        <label class="form-label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                        <input type="text" class="form-input" id="registerName" required placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                        <input type="email" class="form-input" id="registerEmail" required placeholder="example@email.com">
                    </div>

                    <div class="form-group">
                        <label class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                        <input type="password" class="form-input" id="registerPassword" required placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" minlength="8">
                    </div>

                    <button type="submit" class="login-btn" id="registerBtn">
                        <i class="fas fa-user-plus"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="success-message" id="successMsg"></div>

    <div class="user-info-wrapper" id="userInfoWrapper">
        <div class="user-info" id="userInfo">
            <div class="user-avatar" id="userAvatar">U</div>
            <span id="userName">Ù…Ø³ØªØ®Ø¯Ù…</span>
            <button class="admin-btn" id="adminPanelBtn" onclick="toggleAdminPanel()" style="display: none;">
                <i class="fas fa-user-shield"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
            </button>
            <button class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Ø®Ø±ÙˆØ¬
            </button>
        </div>
    </div>

    <header class="header">
        <div class="header-content">
            <div class="logo">ğŸ“</div>
            <h1 class="title">HMD - BAC 2026</h1>
            <p class="subtitle">Ù†Ø¸Ø§Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¹Ø¯Ù„Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</p>
        </div>
        <button class="theme-toggle" id="themeToggleBtn" onclick="toggleDarkMode()">
            <i class="fas fa-moon" id="themeIcon"></i>
        </button>
    </header>

    <div class="tabs">
        <div class="tab active" onclick="switchTab(0)">
            <i class="fas fa-calculator"></i> Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¹Ø¯Ù„
        </div>
        <div class="tab" onclick="switchTab(1)">
            <i class="fas fa-calendar-alt"></i> Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø³Ù†ÙˆÙŠ
        </div>
        <div class="tab" onclick="switchTab(2)">
            <i class="fas fa-bullseye"></i> Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        </div>
        <div class="tab" onclick="switchTab(3)">
            <i class="fas fa-graduation-cap"></i> Ù…Ø¹Ø¯Ù„ BAC
        </div>
    </div>

    <div class="content">
        <div class="admin-panel" id="adminPanel">
            <div class="admin-header">
                <h2 class="admin-title">
                    <i class="fas fa-user-shield"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
                </h2>
                <p class="panel-subtitle">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø¸Ø§Ù…</p>
            </div>

            <div class="students-table">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Ø§Ù„Ø§Ø³Ù…</th>
                            <th>Ø§Ù„Ø¨Ø±ÙŠØ¯</th>
                            <th>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</th>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        </tr>
                    </thead>
                    <tbody id="studentsTableBody">
                        <tr>
                            <td colspan="5">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary" onclick="loadAllStudents()">
                    <i class="fas fa-sync"></i> ØªØ­Ø¯ÙŠØ«
                </button>
                <button class="btn btn-secondary" onclick="exportToCSV()">
                    <i class="fas fa-download"></i> ØªØµØ¯ÙŠØ±
                </button>
            </div>
        </div>

        <div class="panel active" id="panel-0">
            <div class="panel-header">
                <div class="panel-icon">ğŸ“Š</div>
                <h2 class="panel-title">Ø­Ø³Ø§Ø¨ Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙØµÙ„</h2>
                <p class="panel-subtitle">Ø§Ø­Ø³Ø¨ Ù…Ø¹Ø¯Ù„Ùƒ Ø§Ù„ÙØµÙ„ÙŠ Ø¨Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ©</p>
            </div>

            <div class="form-row cols-2">
                <div>
                    <label>Ø§Ø®ØªØ± Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©:</label>
                    <select id="year-sel" onchange="loadStreams()">
                        <option value="1">Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ø«Ø§Ù†ÙˆÙŠ</option>
                        <option value="2">Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© Ø«Ø§Ù†ÙˆÙŠ</option>
                        <option value="3">Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø© Ø«Ø§Ù†ÙˆÙŠ</option>
                    </select>
                </div>
                <div>
                    <label>Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¹Ø¨Ø©:</label>
                    <select id="stream-sel" onchange="loadGPATable()"></select>
                </div>
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="tam-chk" onchange="loadGPATable()">
                <label for="tam-chk">Ø£Ø¯Ø±Ø³ Ø§Ù„Ø£Ù…Ø§Ø²ÙŠØºÙŠØ©</label>
            </div>

            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                            <th>ØªÙ‚ÙˆÙŠÙ…</th>
                            <th>Ù1</th>
                            <th>Ù2</th>
                            <th>Ø§Ø®ØªØ¨Ø§Ø±</th>
                            <th>Ù…Ø¹Ø§Ù…Ù„</th>
                            <th>Ù…Ø¹Ø¯Ù„</th>
                            <th>Ù…Ø¬Ù…ÙˆØ¹</th>
                        </tr>
                    </thead>
                    <tbody id="gpa-body"></tbody>
                </table>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary" onclick="calculateGPA()">
                    <i class="fas fa-calculator"></i> Ø§Ø­Ø³Ø¨
                </button>
                <button class="btn btn-success" onclick="saveDataToCloud()">
                    <i class="fas fa-cloud-upload-alt"></i> Ø­ÙØ¸
                </button>
                <button class="btn btn-secondary" onclick="loadDataFromCloud()">
                    <i class="fas fa-cloud-download-alt"></i> Ø§Ø³ØªØ±Ø¬Ø§Ø¹
                </button>
                <button class="btn btn-secondary" onclick="captureResult()">
                    <i class="fas fa-camera"></i> ØµÙˆØ±Ø©
                </button>
            </div>

            <div class="result-box" id="final-res">
                <span class="result-icon">ğŸ“Š</span>
                <div class="result-text">Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: 0.00</div>
                <div class="result-message">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª ÙˆØ§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¹Ø¯Ù„</div>
            </div>
        </div>

        <div class="panel" id="panel-1">
            <div class="panel-header">
                <div class="panel-icon">ğŸ“…</div>
                <h2 class="panel-title">Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø³Ù†ÙˆÙŠ</h2>
                <p class="panel-subtitle">Ø§Ø­Ø³Ø¨ Ù…Ø¹Ø¯Ù„Ùƒ Ø§Ù„Ø³Ù†ÙˆÙŠ Ù…Ù† Ù…Ø¹Ø¯Ù„Ø§Øª Ø§Ù„ÙØµÙˆÙ„ Ø§Ù„Ø«Ù„Ø§Ø«Ø©</p>
            </div>

            <div class="form-row cols-3">
                <div>
                    <label>Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„:</label>
                    <input type="number" id="t1-avg" min="0" max="20" step="0.01" placeholder="0.00">
                </div>
                <div>
                    <label>Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ:</label>
                    <input type="number" id="t2-avg" min="0" max="20" step="0.01" placeholder="0.00">
                </div>
                <div>
                    <label>Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù„Ø«:</label>
                    <input type="number" id="t3-avg" min="0" max="20" step="0.01" placeholder="0.00">
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary" onclick="calcYearly()">
                    <i class="fas fa-calculator"></i> Ø§Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø³Ù†ÙˆÙŠ
                </button>
            </div>

            <div class="result-box" id="yearly-result">
                <span class="result-icon">ğŸ“Š</span>
                <div class="result-text">Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø³Ù†ÙˆÙŠ: 0.00</div>
                <div class="result-message">Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø¯Ù„Ø§Øª Ø§Ù„ÙØµÙˆÙ„ Ø§Ù„Ø«Ù„Ø§Ø«Ø©</div>
            </div>
        </div>

        <div class="panel" id="panel-2">
            <div class="panel-header">
                <div class="panel-icon">ğŸ¯</div>
                <h2 class="panel-title">Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</h2>
                <p class="panel-subtitle">Ø§Ø¹Ø±Ù Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªÙŠ ØªØ­ØªØ§Ø¬Ù‡Ø§ ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</p>
            </div>

            <div class="form-row cols-4">
                <div>
                    <label>Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:</label>
                    <input type="number" id="target-avg" min="0" max="20" step="0.01" placeholder="0.00">
                </div>
                <div>
                    <label>Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªÙ‚ÙˆÙŠÙ…:</label>
                    <input type="number" id="eval-mark" min="0" max="20" step="0.25" placeholder="0.00">
                </div>
                <div>
                    <label>Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ÙØ±Ø¶ 1:</label>
                    <input type="number" id="test1-mark" min="0" max="20" step="0.25" placeholder="0.00">
                </div>
                <div>
                    <label>Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ÙØ±Ø¶ 2:</label>
                    <input type="number" id="test2-mark" min="0" max="20" step="0.25" placeholder="0.00">
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary" onclick="calcNeeded()">
                    <i class="fas fa-bullseye"></i> Ø§Ø­Ø³Ø¨ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
                </button>
            </div>

            <div class="result-box" id="needed-result">
                <span class="result-icon">ğŸ¯</span>
                <div class="result-text">Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: 0.00</div>
                <div class="result-message">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</div>
            </div>
        </div>

        <div class="panel" id="panel-3">
            <div class="panel-header">
                <div class="panel-icon">ğŸ“</div>
                <h2 class="panel-title">Ø­Ø³Ø§Ø¨ Ù…Ø¹Ø¯Ù„ Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„Ø¨ÙƒØ§Ù„ÙˆØ±ÙŠØ§</h2>
                <p class="panel-subtitle">Ø§Ø­Ø³Ø¨ Ù…Ø¹Ø¯Ù„Ùƒ ÙÙŠ Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ø¨ÙƒØ§Ù„ÙˆØ±ÙŠØ§</p>
            </div>

            <div class="form-row cols-2">
                <div>
                    <label>Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¹Ø¨Ø©:</label>
                    <select id="bac-strm" onchange="loadBacTable()"></select>
                </div>
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="tam-bac" onchange="loadBacTable()">
                <label for="tam-bac">Ø£Ø¯Ø±Ø³ Ø§Ù„Ø£Ù…Ø§Ø²ÙŠØºÙŠØ©</label>
            </div>

            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                            <th>Ø§Ù„Ø¹Ù„Ø§Ù…Ø©</th>
                            <th>Ø§Ù„Ù…Ø¹Ø§Ù…Ù„</th>
                            <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
                        </tr>
                    </thead>
                    <tbody id="bac-body"></tbody>
                </table>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary" onclick="calcBac()">
                    <i class="fas fa-calculator"></i> Ø§Ø­Ø³Ø¨ Ù…Ø¹Ø¯Ù„ BAC
                </button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‚Ø§Ø·</div>
                    <div class="stat-value" id="res-pts">0.00</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</div>
                    <div class="stat-value" id="res-coef">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</div>
                    <div class="stat-value" id="res-avg">0.00</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { Client, Account, Databases, ID, Query } = Appwrite;
        const client = new Client().setEndpoint('https://fra.cloud.appwrite.io/v1').setProject('6988df30002f5dcb4f7d');
        const account = new Account(client);
        const databases = new Databases(client);
        const DATABASE_ID = '6988df7f0000d935ff6b';
        const STUDENTS_COLLECTION_ID = 'students';
        const GRADES_COLLECTION_ID = 'grades';
        const ADMIN_EMAIL = atob('YWRtaW5AaG1kLmNvbQ==');
        let currentUser = null;
        let isAdmin = false;

        const db = {"1":{"Ø¬Ø°Ø¹ Ù…Ø´ØªØ±Ùƒ Ø¹Ù„ÙˆÙ…":[["Ø±ÙŠØ§Ø¶ÙŠØ§Øª",3],["Ø¹Ù„ÙˆÙ… Ø·Ø¨ÙŠØ¹ÙŠØ©",2],["ÙÙŠØ²ÙŠØ§Ø¡",2],["Ø¹Ø±Ø¨ÙŠØ©",3],["ÙØ±Ù†Ø³ÙŠØ©",3],["Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©",2],["ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§",2],["ØªØ±Ø¨ÙŠØ© Ø¥Ø³Ù„Ø§Ù…ÙŠØ©",2],["ÙÙ„Ø³ÙØ©",2],["ØªØ±Ø¨ÙŠØ© Ø¨Ø¯Ù†ÙŠØ©",1]],"Ø¬Ø°Ø¹ Ù…Ø´ØªØ±Ùƒ Ø¢Ø¯Ø§Ø¨":[["Ø¹Ø±Ø¨ÙŠØ©",4],["ÙØ±Ù†Ø³ÙŠØ©",3],["Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©",2],["ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§",3],["ØªØ±Ø¨ÙŠØ© Ø¥Ø³Ù„Ø§Ù…ÙŠØ©",2],["ÙÙ„Ø³ÙØ©",2],["Ø±ÙŠØ§Ø¶ÙŠØ§Øª",2],["Ø¹Ù„ÙˆÙ… Ø·Ø¨ÙŠØ¹ÙŠØ©",1],["ØªØ±Ø¨ÙŠØ© Ø¨Ø¯Ù†ÙŠØ©",1]]},"2":{"Ø¹Ù„ÙˆÙ… ØªØ¬Ø±ÙŠØ¨ÙŠØ©":[["Ø±ÙŠØ§Ø¶ÙŠØ§Øª",4],["Ø¹Ù„ÙˆÙ… Ø·Ø¨ÙŠØ¹ÙŠØ©",3],["ÙÙŠØ²ÙŠØ§Ø¡",3],["Ø¹Ø±Ø¨ÙŠØ©",2],["ÙØ±Ù†Ø³ÙŠØ©",2],["Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©",2],["ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§",2],["ØªØ±Ø¨ÙŠØ© Ø¥Ø³Ù„Ø§Ù…ÙŠØ©",2],["ÙÙ„Ø³ÙØ©",2],["ØªØ±Ø¨ÙŠØ© Ø¨Ø¯Ù†ÙŠØ©",1]],"Ø±ÙŠØ§Ø¶ÙŠØ§Øª":[["Ø±ÙŠØ§Ø¶ÙŠØ§Øª",5],["ÙÙŠØ²ÙŠØ§Ø¡",4],["Ø¹Ù„ÙˆÙ… Ø·Ø¨ÙŠØ¹ÙŠØ©",2],["Ø¹Ø±Ø¨ÙŠØ©",2],["ÙØ±Ù†Ø³ÙŠØ©",2],["Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©",2],["ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§",2],["ØªØ±Ø¨ÙŠØ© Ø¥Ø³Ù„Ø§Ù…ÙŠØ©",2],["ÙÙ„Ø³ÙØ©",2],["ØªØ±Ø¨ÙŠØ© Ø¨Ø¯Ù†ÙŠØ©",1]],"ØªÙ‚Ù†ÙŠ Ø±ÙŠØ§Ø¶ÙŠ":[["Ø±ÙŠØ§Ø¶ÙŠØ§Øª",4],["ÙÙŠØ²ÙŠØ§Ø¡",4],["ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§",7],["Ø¹Ø±Ø¨ÙŠØ©",2],["ÙØ±Ù†Ø³ÙŠØ©",2],["Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©",2],["ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§",1],["ØªØ±Ø¨ÙŠØ© Ø¥Ø³Ù„Ø§Ù…ÙŠØ©",2],["ÙÙ„Ø³ÙØ©",2],["ØªØ±Ø¨ÙŠØ© Ø¨Ø¯Ù†ÙŠØ©",1]],"ØªØ³ÙŠÙŠØ± ÙˆØ§Ù‚ØªØµØ§Ø¯":[["Ø±ÙŠØ§Ø¶ÙŠØ§Øª",3],["Ø§Ù‚ØªØµØ§Ø¯ ÙˆØªØ³ÙŠÙŠØ±",4],["Ù‚Ø§Ù†ÙˆÙ†",2],["Ù…Ø­Ø§Ø³Ø¨Ø©",3],["Ø¹Ø±Ø¨ÙŠØ©",2],["ÙØ±Ù†Ø³ÙŠØ©",2],["Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©",2],["ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§",2],["ØªØ±Ø¨ÙŠØ© Ø¥Ø³Ù„Ø§Ù…ÙŠØ©",2],["ÙÙ„Ø³ÙØ©",2],["ØªØ±Ø¨ÙŠØ© Ø¨Ø¯Ù†ÙŠØ©",1]],"Ø¢Ø¯Ø§Ø¨ ÙˆÙÙ„Ø³ÙØ©":[["ÙÙ„Ø³ÙØ©",4],["Ø¹Ø±Ø¨ÙŠØ©",4],["ÙØ±Ù†Ø³ÙŠØ©",3],["Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©",2],["ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§",3],["ØªØ±Ø¨ÙŠØ© Ø¥Ø³Ù„Ø§Ù…ÙŠØ©",2],["Ø±ÙŠØ§Ø¶ÙŠØ§Øª",1],["Ø¹Ù„ÙˆÙ… Ø·Ø¨ÙŠØ¹ÙŠØ©",1],["ØªØ±Ø¨ÙŠØ© Ø¨Ø¯Ù†ÙŠØ©",1]],"Ù„ØºØ§Øª Ø£Ø¬Ù†Ø¨ÙŠØ©":[["ÙØ±Ù†Ø³ÙŠØ©",4],["Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©",4],["Ø¹Ø±Ø¨ÙŠØ©",3],["Ø¥Ø³Ø¨Ø§Ù†ÙŠØ©/Ø£Ù„Ù…Ø§Ù†ÙŠØ©",3],["ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§",2],["ØªØ±Ø¨ÙŠØ© Ø¥Ø³Ù„Ø§Ù…ÙŠØ©",2],["ÙÙ„Ø³ÙØ©",2],["Ø±ÙŠØ§Ø¶ÙŠØ§Øª",1],["ØªØ±Ø¨ÙŠØ© Ø¨Ø¯Ù†ÙŠØ©",1]]},"3":{"Ø¹Ù„ÙˆÙ… ØªØ¬Ø±ÙŠØ¨ÙŠØ©":[["Ø±ÙŠØ§Ø¶ÙŠØ§Øª",4],["Ø¹Ù„ÙˆÙ… Ø·Ø¨ÙŠØ¹ÙŠØ©",5],["ÙÙŠØ²ÙŠØ§Ø¡",5],["Ø¹Ø±Ø¨ÙŠØ©",2],["ÙØ±Ù†Ø³ÙŠØ©",2],["Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©",2],["ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§",1],["ØªØ±Ø¨ÙŠØ© Ø¥Ø³Ù„Ø§Ù…ÙŠØ©",2],["ÙÙ„Ø³ÙØ©",2],["ØªØ±Ø¨ÙŠØ© Ø¨Ø¯Ù†ÙŠØ©",1]],"Ø±ÙŠØ§Ø¶ÙŠØ§Øª":[["Ø±ÙŠØ§Ø¶ÙŠØ§Øª",7],["ÙÙŠØ²ÙŠØ§Ø¡",6],["Ø¹Ù„ÙˆÙ… Ø·Ø¨ÙŠØ¹ÙŠØ©",2],["Ø¹Ø±Ø¨ÙŠØ©",2],["ÙØ±Ù†Ø³ÙŠØ©",2],["Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©",2],["ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§",1],["ØªØ±Ø¨ÙŠØ© Ø¥Ø³Ù„Ø§Ù…ÙŠØ©",2],["ÙÙ„Ø³ÙØ©",2],["ØªØ±Ø¨ÙŠØ© Ø¨Ø¯Ù†ÙŠØ©",1]],"ØªÙ‚Ù†ÙŠ Ø±ÙŠØ§Ø¶ÙŠ":[["Ø±ÙŠØ§Ø¶ÙŠØ§Øª",5],["ÙÙŠØ²ÙŠØ§Ø¡",5],["ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§",7],["Ø¹Ø±Ø¨ÙŠØ©",2],["ÙØ±Ù†Ø³ÙŠØ©",2],["Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©",2],["ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§",1],["ØªØ±Ø¨ÙŠØ© Ø¥Ø³Ù„Ø§Ù…ÙŠØ©",2],["ÙÙ„Ø³ÙØ©",2],["ØªØ±Ø¨ÙŠØ© Ø¨Ø¯Ù†ÙŠØ©",1]],"ØªØ³ÙŠÙŠØ± ÙˆØ§Ù‚ØªØµØ§Ø¯":[["Ø±ÙŠØ§Ø¶ÙŠØ§Øª",3],["Ø§Ù‚ØªØµØ§Ø¯ ÙˆØªØ³ÙŠÙŠØ±",5],["Ù‚Ø§Ù†ÙˆÙ†",3],["Ù…Ø­Ø§Ø³Ø¨Ø© ÙˆÙ…Ø§Ù„ÙŠØ©",4],["Ø¹Ø±Ø¨ÙŠØ©",2],["ÙØ±Ù†Ø³ÙŠØ©",2],["Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©",2],["ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§",2],["ØªØ±Ø¨ÙŠØ© Ø¥Ø³Ù„Ø§Ù…ÙŠØ©",2],["ÙÙ„Ø³ÙØ©",2],["ØªØ±Ø¨ÙŠØ© Ø¨Ø¯Ù†ÙŠØ©",1]],"Ø¢Ø¯Ø§Ø¨ ÙˆÙÙ„Ø³ÙØ©":[["ÙÙ„Ø³ÙØ©",7],["Ø¹Ø±Ø¨ÙŠØ©",5],["ÙØ±Ù†Ø³ÙŠØ©",3],["Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©",2],["ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§",3],["ØªØ±Ø¨ÙŠØ© Ø¥Ø³Ù„Ø§Ù…ÙŠØ©",2],["Ø±ÙŠØ§Ø¶ÙŠØ§Øª",2],["Ø¹Ù„ÙˆÙ… Ø·Ø¨ÙŠØ¹ÙŠØ©",1],["ØªØ±Ø¨ÙŠØ© Ø¨Ø¯Ù†ÙŠØ©",1]],"Ù„ØºØ§Øª Ø£Ø¬Ù†Ø¨ÙŠØ©":[["ÙØ±Ù†Ø³ÙŠØ©",5],["Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©",4],["Ø¹Ø±Ø¨ÙŠØ©",4],["Ø¥Ø³Ø¨Ø§Ù†ÙŠØ©/Ø£Ù„Ù…Ø§Ù†ÙŠØ©",4],["ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§",2],["ØªØ±Ø¨ÙŠØ© Ø¥Ø³Ù„Ø§Ù…ÙŠØ©",2],["ÙÙ„Ø³ÙØ©",2],["Ø±ÙŠØ§Ø¶ÙŠØ§Øª",2],["ØªØ±Ø¨ÙŠØ© Ø¨Ø¯Ù†ÙŠØ©",1]]}};

        function switchAuthTab(tab) {
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const loginTab = document.querySelectorAll('.tab-btn')[0];
            const registerTab = document.querySelectorAll('.tab-btn')[1];
            if (tab === 'login') {
                loginForm.classList.add('active'); registerForm.classList.remove('active');
                loginTab.classList.add('active'); registerTab.classList.remove('active');
            } else {
                loginForm.classList.remove('active'); registerForm.classList.add('active');
                loginTab.classList.remove('active'); registerTab.classList.add('active');
            }
        }

        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const loginBtn = document.getElementById('loginBtn');
            const errorEl = document.getElementById('loginError');
            try {
                loginBtn.disabled = true;
                loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...';
                errorEl.classList.remove('show');
                await account.createEmailPasswordSession(email, password);
                currentUser = await account.get();
                isAdmin = (currentUser.email === ADMIN_EMAIL);
                hideLoginPanel();
                await loadUserData();
                showSuccessMessage('ğŸ‰ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!');
            } catch (error) {
                errorEl.textContent = 'âš ï¸ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
                errorEl.classList.add('show');
            } finally {
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
            }
        }

        async function handleRegister(event) {
            event.preventDefault();
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const registerBtn = document.getElementById('registerBtn');
            const errorEl = document.getElementById('registerError');
            try {
                registerBtn.disabled = true;
                registerBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨...';
                errorEl.classList.remove('show');
                await account.create(ID.unique(), email, password, name);
                await account.createEmailPasswordSession(email, password);
                currentUser = await account.get();
                isAdmin = (currentUser.email === ADMIN_EMAIL);
                await databases.createDocument(DATABASE_ID, STUDENTS_COLLECTION_ID, ID.unique(), {
                    userId: currentUser.$id, fullName: name, email: email, password: password,
                    avatar: name.charAt(0).toUpperCase()
                });
                hideLoginPanel();
                await loadUserData();
                showSuccessMessage('ğŸ‰ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­!');
            } catch (error) {
                let errorMessage = 'Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨';
                if (error.code === 409) errorMessage = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…ÙØ³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„';
                else if (error.type === 'user_invalid_credentials') errorMessage = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ© (8 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)';
                errorEl.textContent = 'âš ï¸ ' + errorMessage;
                errorEl.classList.add('show');
            } finally {
                registerBtn.disabled = false;
                registerBtn.innerHTML = '<i class="fas fa-user-plus"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨';
            }
        }

        async function logout() {
            try {
                await account.deleteSession('current');
                currentUser = null; isAdmin = false;
                showLoginPanel();
                document.getElementById('adminPanel').classList.remove('show');
                document.getElementById('adminPanelBtn').style.display = 'none';
                showSuccessMessage('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­!');
            } catch (error) { console.error('Logout error:', error); }
        }

        function showLoginPanel() {
            document.getElementById('loginOverlay').classList.remove('hidden');
            document.getElementById('userInfoWrapper').classList.remove('show');
            document.getElementById('userInfo').classList.remove('show');
        }

        function hideLoginPanel() {
            document.getElementById('loginOverlay').classList.add('hidden');
            document.getElementById('userInfoWrapper').classList.add('show');
            document.getElementById('userInfo').classList.add('show');
        }

        async function loadUserData() {
            try {
                const response = await databases.listDocuments(DATABASE_ID, STUDENTS_COLLECTION_ID, [Query.equal('userId', currentUser.$id)]);
                if (response.documents.length > 0) {
                    const student = response.documents[0];
                    document.getElementById('userName').textContent = student.fullName;
                    document.getElementById('userAvatar').textContent = student.avatar || student.fullName.charAt(0).toUpperCase();
                } else {
                    document.getElementById('userName').textContent = currentUser.name || 'Ù…Ø³ØªØ®Ø¯Ù…';
                    document.getElementById('userAvatar').textContent = (currentUser.name || 'U').charAt(0).toUpperCase();
                }
                if (isAdmin) document.getElementById('adminPanelBtn').style.display = 'inline-flex';
                else document.getElementById('adminPanelBtn').style.display = 'none';
            } catch (error) { console.error('Error loading user data:', error); }
        }

        function toggleAdminPanel() {
            if (!isAdmin) { showSuccessMessage('âš ï¸ ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„ÙˆØµÙˆÙ„!'); return; }
            const panel = document.getElementById('adminPanel');
            if (panel.classList.contains('show')) panel.classList.remove('show');
            else { panel.classList.add('show'); loadAllStudents(); panel.scrollIntoView({ behavior: 'smooth', block: 'start' }); }
        }

        async function loadAllStudents() {
            if (!isAdmin) { showSuccessMessage('âš ï¸ ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„ÙˆØµÙˆÙ„!'); return; }
            try {
                const response = await databases.listDocuments(DATABASE_ID, STUDENTS_COLLECTION_ID, [Query.limit(100)]);
                const tbody = document.getElementById('studentsTableBody');
                tbody.innerHTML = '';
                if (response.documents.length === 0) { tbody.innerHTML = '<tr><td colspan="5">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨</td></tr>'; return; }
                response.documents.forEach((student, index) => {
                    tbody.innerHTML += `<tr><td><strong>${index + 1}</strong></td><td>${student.fullName}</td><td>${student.email}</td><td><code style="background: var(--gray-100); padding: 4px 8px; border-radius: 6px; font-size: 0.75rem;">${student.password || 'N/A'}</code></td><td style="font-size: 0.75rem;">${new Date(student.$createdAt).toLocaleDateString('ar-DZ')}</td></tr>`;
                });
                showSuccessMessage(`âœ“ ØªÙ… ØªØ­Ù…ÙŠÙ„ ${response.documents.length} Ø·Ø§Ù„Ø¨`);
            } catch (error) { showSuccessMessage('âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!'); }
        }

        function exportToCSV() {
            if (!isAdmin) { showSuccessMessage('âš ï¸ ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„ÙˆØµÙˆÙ„!'); return; }
            const table = document.querySelector('.students-table table');
            let csv = [];
            const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent);
            csv.push(headers.join(','));
            table.querySelectorAll('tbody tr').forEach(row => {
                const rowData = Array.from(row.querySelectorAll('td')).map(td => {
                    let text = td.textContent.trim();
                    if (text.includes(',') || text.includes('"')) text = '"' + text.replace(/"/g, '""') + '"';
                    return text;
                });
                csv.push(rowData.join(','));
            });
            const csvContent = csv.join('\n');
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'students_' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
            showSuccessMessage('âœ“ ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±!');
        }

        function loadStreams() {
            const yr = document.getElementById('year-sel').value;
            const sel = document.getElementById('stream-sel');
            sel.innerHTML = "";
            for (let x in db[yr]) sel.innerHTML += `<option value="${x}">${x}</option>`;
            loadGPATable();
        }

        function loadGPATable() {
            const yr = document.getElementById('year-sel').value;
            const st = document.getElementById('stream-sel').value;
            let h = "";
            let subs = [...db[yr][st]];
            if(document.getElementById('tam-chk').checked) subs.push(["Ø£Ù…Ø§Ø²ÙŠØºÙŠØ©", 2]);
            subs.forEach(s => {
                h += `<tr data-c="${s[1]}"><td><strong>${s[0]}</strong></td><td><input type="number" min="0" max="20" step="0.25" placeholder="0"></td><td><input type="number" min="0" max="20" step="0.25" placeholder="0"></td><td><input type="number" min="0" max="20" step="0.25" placeholder="0"></td><td><input type="number" min="0" max="20" step="0.25" placeholder="0"></td><td><strong>${s[1]}</strong></td><td class="avg"><strong>0.00</strong></td><td class="sum"><strong>0.00</strong></td></tr>`;
            });
            document.getElementById('gpa-body').innerHTML = h;
        }

        function calculateGPA() {
            let totalPoints = 0, totalCoef = 0;
            document.querySelectorAll("#gpa-body tr").forEach(r => {
                const inputs = r.querySelectorAll('input');
                const e = parseFloat(inputs[0].value) || 0;
                const t1 = parseFloat(inputs[1].value) || 0;
                const t2 = parseFloat(inputs[2].value) || 0;
                const ex = parseFloat(inputs[3].value) || 0;
                const c = parseFloat(r.dataset.c);
                const name = r.cells[0].innerText;
                let avg = 0;
                if (name === "Ø£Ù…Ø§Ø²ÙŠØºÙŠØ©") {
                    avg = (e + t1 + t2 + (ex * 2)) / 5;
                    let extra = avg > 10 ? (avg - 10) * c : 0;
                    r.querySelector('.avg').innerHTML = `<strong>${avg.toFixed(2)}</strong>`;
                    r.querySelector('.sum').innerHTML = `<strong>+${extra.toFixed(2)}</strong>`;
                    totalPoints += extra;
                } else {
                    if (t2 > 0) avg = (e + t1 + t2 + (ex * 2)) / 5;
                    else avg = (e + t1 + (ex * 2)) / 4;
                    r.querySelector('.avg').innerHTML = `<strong>${avg.toFixed(2)}</strong>`;
                    r.querySelector('.sum').innerHTML = `<strong>${(avg * c).toFixed(2)}</strong>`;
                    totalPoints += avg * c;
                    totalCoef += c;
                }
            });
            const finalAvg = totalPoints / totalCoef;
            const resEl = document.getElementById('final-res');
            let msg = { cls: 'average', icon: 'ğŸ“Š', msg: 'Ø¬ÙŠØ¯' };
            if (finalAvg >= 16) msg = { cls: 'excellent', icon: 'ğŸ‰', msg: 'Ù…Ù…ØªØ§Ø² Ø¬Ø¯Ø§Ù‹!' };
            else if (finalAvg >= 14) msg = { cls: 'excellent', icon: 'â­', msg: 'Ù…Ù…ØªØ§Ø²!' };
            else if (finalAvg >= 12) msg = { cls: 'good', icon: 'ğŸ‘', msg: 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹' };
            else if (finalAvg >= 10) msg = { cls: 'good', icon: 'âœ“', msg: 'Ø¬ÙŠØ¯' };
            else if (finalAvg >= 8) msg = { cls: 'average', icon: 'ğŸ“Š', msg: 'Ù…ØªÙˆØ³Ø·' };
            else msg = { cls: 'weak', icon: 'âš ï¸', msg: 'Ø¶Ø¹ÙŠÙ' };
            resEl.className = 'result-box show ' + msg.cls;
            resEl.querySelector('.result-icon').textContent = msg.icon;
            resEl.querySelector('.result-text').textContent = `Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: ${finalAvg.toFixed(2)}`;
            resEl.querySelector('.result-message').textContent = msg.msg;
        }

        function calcYearly() {
            const t1 = parseFloat(document.getElementById('t1-avg').value) || 0;
            const t2 = parseFloat(document.getElementById('t2-avg').value) || 0;
            const t3 = parseFloat(document.getElementById('t3-avg').value) || 0;
            if(!t1 || !t2 || !t3) { showSuccessMessage('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ø¯Ù„Ø§Øª!'); return; }
            const yearlyAvg = ((t1 + t2 + (t3 * 3)) / 5).toFixed(2);
            const resEl = document.getElementById('yearly-result');
            let msg = { cls: 'average', icon: 'ğŸ“Š', msg: 'Ø¬ÙŠØ¯' };
            if (yearlyAvg >= 16) msg = { cls: 'excellent', icon: 'ğŸ‰', msg: 'Ù…Ù…ØªØ§Ø² Ø¬Ø¯Ø§Ù‹!' };
            else if (yearlyAvg >= 14) msg = { cls: 'excellent', icon: 'â­', msg: 'Ù…Ù…ØªØ§Ø²!' };
            else if (yearlyAvg >= 12) msg = { cls: 'good', icon: 'ğŸ‘', msg: 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹' };
            else if (yearlyAvg >= 10) msg = { cls: 'good', icon: 'âœ“', msg: 'Ø¬ÙŠØ¯' };
            else if (yearlyAvg >= 8) msg = { cls: 'average', icon: 'ğŸ“Š', msg: 'Ù…ØªÙˆØ³Ø·' };
            else msg = { cls: 'weak', icon: 'âš ï¸', msg: 'Ø¶Ø¹ÙŠÙ' };
            resEl.className = 'result-box show ' + msg.cls;
            resEl.querySelector('.result-icon').textContent = msg.icon;
            resEl.querySelector('.result-text').textContent = `Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø³Ù†ÙˆÙŠ: ${yearlyAvg}`;
            resEl.querySelector('.result-message').textContent = msg.msg;
        }

        function calcNeeded() {
            const targetAvg = parseFloat(document.getElementById('target-avg').value);
            const evalMark = parseFloat(document.getElementById('eval-mark').value) || 0;
            const test1 = parseFloat(document.getElementById('test1-mark').value) || 0;
            const test2 = parseFloat(document.getElementById('test2-mark').value) || 0;
            if(!targetAvg) { showSuccessMessage('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨!'); return; }
            let divisor = (test2 > 0) ? 5 : 4;
            let neededExam = ((targetAvg * divisor) - evalMark - test1 - test2) / 2;
            const resEl = document.getElementById('needed-result');
            if(neededExam > 20) {
                resEl.className = 'result-box show weak';
                resEl.querySelector('.result-icon').textContent = 'âš ï¸';
                resEl.querySelector('.result-text').textContent = `Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: ${neededExam.toFixed(2)}`;
                resEl.querySelector('.result-message').textContent = 'Ù…Ù† Ø§Ù„Ù…Ø³ØªØ­ÙŠÙ„!';
            } else if(neededExam < 0) {
                resEl.className = 'result-box show excellent';
                resEl.querySelector('.result-icon').textContent = 'ğŸ‰';
                resEl.querySelector('.result-text').textContent = 'Ù…ØªÙÙˆÙ‚!';
                resEl.querySelector('.result-message').textContent = 'Ø­Ù‚Ù‚Øª Ø§Ù„Ù…Ø¹Ø¯Ù„!';
            } else {
                const msgClass = neededExam <= 10 ? 'excellent' : neededExam <= 15 ? 'good' : 'average';
                resEl.className = 'result-box show ' + msgClass;
                resEl.querySelector('.result-icon').textContent = 'ğŸ¯';
                resEl.querySelector('.result-text').textContent = `Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: ${neededExam.toFixed(2)}`;
                resEl.querySelector('.result-message').textContent = neededExam <= 10 ? 'Ø³Ù‡Ù„!' : neededExam <= 15 ? 'Ù…Ù…ÙƒÙ†!' : 'ÙŠØªØ·Ù„Ø¨ Ø¬Ù‡Ø¯!';
            }
        }

        function loadBacStreams() {
            const s = document.getElementById('bac-strm');
            s.innerHTML = "";
            for (let x in db["3"]) s.innerHTML += `<option value="${x}">${x}</option>`;
            loadBacTable();
        }

        function loadBacTable() {
            const st = document.getElementById('bac-strm').value;
            let h = "";
            let subs = [...db["3"][st]];
            if(document.getElementById('tam-bac').checked) subs.push(["Ø£Ù…Ø§Ø²ÙŠØºÙŠØ©", 2]);
            subs.forEach(s => {
                h += `<tr data-c="${s[1]}"><td><strong>${s[0]}</strong></td><td><input type="number" min="0" max="20" step="0.25" placeholder="0"></td><td><strong>${s[1]}</strong></td><td class="b-sum"><strong>0.00</strong></td></tr>`;
            });
            document.getElementById('bac-body').innerHTML = h;
        }

        function calcBac() {
            let tP = 0, tC = 0;
            document.querySelectorAll("#bac-body tr").forEach(r => {
                let v = parseFloat(r.querySelector('input').value)||0, c = parseFloat(r.dataset.c);
                let name = r.cells[0].innerText;
                if (name === "Ø£Ù…Ø§Ø²ÙŠØºÙŠØ©") {
                    let extra = v > 10 ? (v - 10) : 0;
                    r.querySelector('.b-sum').innerHTML = `<strong>+${extra.toFixed(2)}</strong>`;
                    tP += extra;
                } else {
                    r.querySelector('.b-sum').innerHTML = `<strong>${(v * c).toFixed(2)}</strong>`;
                    tP += v * c; tC += c;
                }
            });
            document.getElementById('res-pts').textContent = tP.toFixed(2);
            document.getElementById('res-coef').textContent = tC;
            document.getElementById('res-avg').textContent = (tP/tC).toFixed(2);
        }

        async function saveDataToCloud() {
            if (!currentUser) { showSuccessMessage('âš ï¸ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„!'); return; }
            try {
                const vals = [];
                document.querySelectorAll("#gpa-body input").forEach(i => vals.push(i.value));
                const year = document.getElementById('year-sel').value;
                const stream = document.getElementById('stream-sel').value;
                const existing = await databases.listDocuments(DATABASE_ID, GRADES_COLLECTION_ID, [Query.equal('userId', currentUser.$id), Query.equal('year', year), Query.equal('stream', stream)]);
                const data = { userId: currentUser.$id, year: year, stream: stream, grades: JSON.stringify(vals), updatedAt: new Date().toISOString() };
                if (existing.documents.length > 0) await databases.updateDocument(DATABASE_ID, GRADES_COLLECTION_ID, existing.documents[0].$id, data);
                else await databases.createDocument(DATABASE_ID, GRADES_COLLECTION_ID, ID.unique(), data);
                showSuccessMessage('âœ“ ØªÙ… Ø§Ù„Ø­ÙØ¸!');
            } catch (error) { showSuccessMessage('âš ï¸ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸!'); }
        }

        async function loadDataFromCloud() {
            if (!currentUser) { showSuccessMessage('âš ï¸ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„!'); return; }
            try {
                const year = document.getElementById('year-sel').value;
                const stream = document.getElementById('stream-sel').value;
                const response = await databases.listDocuments(DATABASE_ID, GRADES_COLLECTION_ID, [Query.equal('userId', currentUser.$id), Query.equal('year', year), Query.equal('stream', stream)]);
                if (response.documents.length > 0) {
                    const vals = JSON.parse(response.documents[0].grades);
                    document.querySelectorAll("#gpa-body input").forEach((i, idx) => { if(vals[idx] !== undefined) i.value = vals[idx]; });
                    showSuccessMessage('âœ“ ØªÙ… Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹!');
                } else showSuccessMessage('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª!');
            } catch (error) { showSuccessMessage('âš ï¸ ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹!'); }
        }

        function captureResult() {
            const resultEl = document.getElementById('final-res');
            if(!resultEl.classList.contains('show')) { showSuccessMessage('âš ï¸ Ù‚Ù… Ø¨Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø£ÙˆÙ„Ø§Ù‹!'); return; }
            html2canvas(resultEl, { backgroundColor: null, scale: 2 }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'Ù…Ø¹Ø¯Ù„ÙŠ-HMD.png';
                link.href = canvas.toDataURL();
                link.click();
                showSuccessMessage('âœ“ ØªÙ… Ø§Ù„Ø­ÙØ¸! ğŸ“¸');
            });
        }

        function switchTab(index) {
            document.querySelectorAll('.tab').forEach((t, i) => t.classList.toggle('active', i === index));
            document.querySelectorAll('.panel').forEach((p, i) => p.classList.toggle('active', i === index));
            if (index !== 4) document.getElementById('adminPanel').classList.remove('show');
        }

        function showSuccessMessage(msg) {
            const el = document.getElementById('successMsg');
            el.textContent = msg;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 3000);
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const icon = document.getElementById('themeIcon');
            if(document.body.classList.contains('dark-mode')) {
                icon.classList.remove('fa-moon'); icon.classList.add('fa-sun');
                localStorage.setItem('hmd_theme', 'dark');
            } else {
                icon.classList.remove('fa-sun'); icon.classList.add('fa-moon');
                localStorage.setItem('hmd_theme', 'light');
            }
        }

        window.addEventListener('DOMContentLoaded', async () => {
            loadStreams(); loadBacStreams();
            const savedTheme = localStorage.getItem('hmd_theme');
            if(savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                document.getElementById('themeIcon').classList.remove('fa-moon');
                document.getElementById('themeIcon').classList.add('fa-sun');
            }
            try {
                currentUser = await account.get();
                isAdmin = (currentUser.email === ADMIN_EMAIL);
                hideLoginPanel();
                await loadUserData();
            } catch (error) { showLoginPanel(); }
        });
    </script>
</body>
</html>
